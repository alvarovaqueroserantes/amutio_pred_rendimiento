import streamlit as st
import pandas as pd
import numpy as np
import joblib
from streamlit_echarts import st_echarts
from tensorflow.keras.models import load_model

# CONFIGURACIÓN
st.set_page_config(
    page_title="AMUTIO Predictive Dashboard",
    page_icon="images/logo.png",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ESTILOS AVANZADOS
st.markdown("""
    <style>
    .header-container {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 10px;
    }
    .header-title {
        color: #2E7D32;
        font-size: 2em;
        font-weight: 600;
        margin: 0;
    }
    .header-subtitle {
        font-size: 0.9em;
        color: #555;
        margin: 0;
    }
    .footer {
        font-size: 0.85em;
        color: #666;
        text-align: center;
        margin-top: 30px;
        border-top: 1px solid #ddd;
        padding-top: 10px;
    }
    </style>
""", unsafe_allow_html=True)

# CABECERA CORPORATIVA
col_logo, col_text = st.columns([1, 12])
with col_logo:
    st.image("images/logo.png", width=65)
with col_text:
    st.markdown("""
        <div class="header-container">
            <div>
                <div class="header-title">AMUTIO Predictive IA</div>
                <div class="header-subtitle">Centro de Control — Dashboard 2025</div>
            </div>
        </div>
    """, unsafe_allow_html=True)

st.markdown("""<hr style="margin-top:-10px; margin-bottom:20px;">""", unsafe_allow_html=True)

# MODELOS
with st.spinner("Cargando modelos..."):
    stack_model = joblib.load("modelo_stack.pkl")
    lstm_model = load_model("modelo_lstm.h5", compile=False)

# SIDEBAR
with st.sidebar:
    st.header("Datos de entrada")
    uploaded_file = st.file_uploader("Archivo de seguimiento semanal (CSV)", type=["csv"])
    uploaded_forecast = st.file_uploader("Archivo de predicción meteorológica (CSV)", type=["csv"])
    st.markdown("---")
    st.caption("Versión MVP 2025")

# CONTENIDO
if uploaded_file:
    df = pd.read_csv(uploaded_file, parse_dates=["fecha"])
    parcelas = df["parcela"].unique()

    if uploaded_forecast:
        df_forecast = pd.read_csv(uploaded_forecast, parse_dates=["fecha"])
    else:
        st.sidebar.warning("No se ha cargado predicción meteorológica")

    st.selectbox("Modo de análisis:", ["Visión general", "Detalle por parcela"], key="modo")

    if st.session_state.modo == "Visión general":
        st.subheader("Visión general de predicciones")

        global_preds = []
        for parcela in parcelas:
            datos_p = df[df["parcela"] == parcela].sort_values("fecha")
            mes_cosecha = datos_p["fecha"].max().month
            variedad = datos_p["variedad"].iloc[-1]
            variedad_code = {"Agria": 0, "Monalisa": 1, "Spunta": 2}[variedad]
            tam_parcela_ha = datos_p["tam_parcela_ha"].iloc[-1]
            temp_media = datos_p["temp_media"].mean()
            temp_std = datos_p["temp_media"].std()
            lluvia_total = datos_p["lluvia"].sum()
            fertilizante_total = datos_p["fertilizante"].sum()
            fertilizante_medio = datos_p["fertilizante"].mean()
            riego_total = datos_p["riego"].sum()
            riego_medio = datos_p["riego"].mean()

            X_input = np.array([[variedad_code, tam_parcela_ha, temp_media, temp_std,
                                 lluvia_total, fertilizante_total, fertilizante_medio,
                                 riego_total, riego_medio, mes_cosecha]])
            pred = stack_model.predict(X_input)[0]
            global_preds.append(pred)

        # métricas con colores profesionales
        col_a, col_b, col_c, col_d = st.columns(4)

        with col_a:
            st.markdown(f"""
            <div style="background:#E8F5E9; border-radius:10px; padding:15px; text-align:center; border:1px solid #C8E6C9;">
                <div style="font-size:0.9em; color:#2E7D32; font-weight:bold;">Rendimiento medio</div>
                <div style="font-size:1.6em; font-weight:bold; color:#1B5E20;">{np.mean(global_preds):.2f} ton/ha</div>
            </div>
            """, unsafe_allow_html=True)

        with col_b:
            st.markdown(f"""
            <div style="background:#FFFDE7; border-radius:10px; padding:15px; text-align:center; border:1px solid #FFF9C4;">
                <div style="font-size:0.9em; color:#F57F17; font-weight:bold;">Mejor parcela</div>
                <div style="font-size:1.6em; font-weight:bold; color:#F57F17;">{np.max(global_preds):.2f} ton/ha</div>
            </div>
            """, unsafe_allow_html=True)

        with col_c:
            st.markdown(f"""
            <div style="background:#FFEBEE; border-radius:10px; padding:15px; text-align:center; border:1px solid #FFCDD2;">
                <div style="font-size:0.9em; color:#C62828; font-weight:bold;">Peor parcela</div>
                <div style="font-size:1.6em; font-weight:bold; color:#B71C1C;">{np.min(global_preds):.2f} ton/ha</div>
            </div>
            """, unsafe_allow_html=True)

        with col_d:
            st.markdown(f"""
            <div style="background:#E3F2FD; border-radius:10px; padding:15px; text-align:center; border:1px solid #BBDEFB;">
                <div style="font-size:0.9em; color:#1565C0; font-weight:bold;">Variabilidad</div>
                <div style="font-size:1.6em; font-weight:bold; color:#0D47A1;">{np.std(global_preds):.2f} ton/ha</div>
            </div>
            """, unsafe_allow_html=True)

        # indicadores ambientales
        media_temp = df["temp_media"].mean()
        media_lluvia = df["lluvia"].mean()
        media_fertilizante = df["fertilizante"].mean()
        media_riego = df["riego"].mean()

        st.markdown("#### Condiciones globales promedio")
        col1, col2, col3, col4 = st.columns(4)

        with col1:
            st.markdown(f"""
            <div style="background:#F1F8E9; border-radius:10px; padding:10px; text-align:center;">
                <span style="font-size:0.9em; color:#558B2F; font-weight:bold;">Temperatura media</span><br>
                <span style="font-size:1.4em; font-weight:bold;">{media_temp:.1f} °C</span>
            </div>
            """, unsafe_allow_html=True)

        with col2:
            st.markdown(f"""
            <div style="background:#E8F5E9; border-radius:10px; padding:10px; text-align:center;">
                <span style="font-size:0.9em; color:#33691E; font-weight:bold;">Lluvia media</span><br>
                <span style="font-size:1.4em; font-weight:bold;">{media_lluvia:.1f} mm/semana</span>
            </div>
            """, unsafe_allow_html=True)

        with col3:
            st.markdown(f"""
            <div style="background:#FFF8E1; border-radius:10px; padding:10px; text-align:center;">
                <span style="font-size:0.9em; color:#FF8F00; font-weight:bold;">Fertilizante medio</span><br>
                <span style="font-size:1.4em; font-weight:bold;">{media_fertilizante:.1f} kg/semana</span>
            </div>
            """, unsafe_allow_html=True)

        with col4:
            st.markdown(f"""
            <div style="background:#E1F5FE; border-radius:10px; padding:10px; text-align:center;">
                <span style="font-size:0.9em; color:#0288D1; font-weight:bold;">Riego medio</span><br>
                <span style="font-size:1.4em; font-weight:bold;">{media_riego:.1f} mm/semana</span>
            </div>
            """, unsafe_allow_html=True)

        # ranking
        st.markdown("#### Ranking de parcelas")
        ranking_df = pd.DataFrame({
            "Parcela": parcelas,
            "Predicción rendimiento (ton/ha)": global_preds
        }).sort_values(by="Predicción rendimiento (ton/ha)", ascending=False)
        st.dataframe(ranking_df, use_container_width=True)

        # gráfico de barras
        st.markdown("#### Distribución de rendimiento por parcela")
        bar_chart_opt = {
            "xAxis": {
                "type": "category",
                "data": ranking_df["Parcela"].tolist(),
            },
            "yAxis": {
                "type": "value",
                "name": "ton/ha",
                "nameLocation": "middle",
                "nameGap": 30,
            },
            "series": [
                {
                    "data": [round(x, 2) for x in ranking_df["Predicción rendimiento (ton/ha)"]],
                    "type": "bar",
                    "label": {"show": True, "position": "top"},
                    "itemStyle": {"color": "#4CAF50"},
                }
            ],
            "tooltip": {"trigger": "axis"},
            "grid": {"left": "3%", "right": "4%", "bottom": "3%", "containLabel": True},
        }
        st_echarts(options=bar_chart_opt, height="400px")
        
        import folium
        from streamlit_folium import st_folium
        import streamlit.components.v1 as components

        # coordenadas aproximadas de parcelas ficticias alrededor de Cartagena
        parcel_coords = {
            "Agria_p1": [
                (37.69885521216946, -1.0296887438745046),
                (37.69910123193867, -1.0297153857553234),
                (37.69919444122206, -1.0297254448779192),
                (37.69919459796368, -1.0297249411255085),
                (37.69936912428554, -1.0297474079801086),
                (37.69939821032945, -1.0296645092764203),
                (37.69928622055271, -1.0294099273925976),
                (37.699285484621555, -1.0294124687857906),
                (37.69925437518609, -1.0293451478500752),
                (37.69918731911852, -1.0292003873445323),
                (37.69913065577332, -1.0291640090444092),
                (37.69916954948275, -1.0290949404817784),
                (37.69902300111714, -1.0290153107205218),
                (37.69886238456442, -1.0296599553881558),
                (37.69885521216946, -1.0296887438745046),
            ],
            "Agria_p2": [
                (37.69902300111714, -1.0290153107205218),
                (37.69916954948275, -1.0290949404817784),
                (37.69913065577332, -1.0291640090444092),
                (37.69918731911852, -1.0292003873445323),
                (37.69925437518609, -1.0293451478500752),
                (37.69930882570873, -1.029213610635764),
                (37.69909446606604, -1.0287284819768951),
                (37.69902300111714, -1.0290153107205218),
            ],
            "Agria_p3": [
                (37.69766024439619, -1.0252300581100617),
                (37.69832563762817, -1.026746109790868),
                (37.69838427155892, -1.026745880964898),
                (37.69847108209706, -1.0267455423359895),
                (37.69864097825533, -1.0267682581331288),
                (37.69888054982607, -1.026861714682681),
                (37.6989772342467, -1.0269171760628923),
                (37.69897882261746, -1.0269180871758214),
                (37.69898336393288, -1.026894606110877),
                (37.699014321655895, -1.026734540249231),
                (37.69902890616828, -1.0264755570277901),
                (37.69902890616828, -1.0264755545132191),
                (37.69901820080092, -1.0264071422536458),
                (37.69901802981006, -1.0264060526061687),
                (37.69901709941877, -1.0264001064837045),
                (37.69901710025697, -1.0264001064837045),
                (37.699062542747726, -1.0264075370413086),
                (37.69907140996361, -1.0264089871106437),
                (37.699167023176955, -1.026419494665086),
                (37.69929883280314, -1.026438903801227),
                (37.69947961034876, -1.026465640397557),
                (37.69947896578037, -1.0264723341858286),
                (37.69945338001945, -1.0267378963634606),
                (37.699457956538836, -1.026736225850059),
                (37.69946214665248, -1.0267390832410206),
                (37.699442900125234, -1.0269968100151006),
                (37.69946335197021, -1.0270030134620078),
                (37.6994525535637, -1.027040513260842),
                (37.69945277065503, -1.0274167811075914),
                (37.6993916548426, -1.0274393896163634),
                (37.69935498904317, -1.0274543295214669),
                (37.699269052737606, -1.027446845319679),
                (37.699276932565226, -1.0273686404820466),
                (37.69932864974909, -1.0273745078146161),
                (37.699343990309174, -1.027125726208134),
                (37.699271419787195, -1.0271162596861279),
                (37.69927073079472, -1.0271161699997586),
                (37.69924776270227, -1.02742387806543),
                (37.69922563363838, -1.027431421778734),
                (37.69899839436253, -1.0274004053823893),
                (37.698996417071456, -1.0273976644998886),
                (37.69899232586427, -1.0274000298731045),
                (37.698983642212085, -1.027379952699241),
                (37.69898309738835, -1.0273789049612823),
                (37.69898418787399, -1.027369091428464),
                (37.69898215358599, -1.0273717568738316),
                (37.69897951160995, -1.0273701433573748),
                (37.698966301729754, -1.0273390003942848),
                (37.69896828404998, -1.0272820487116008),
                (37.69899289667191, -1.026993981960802),
                (37.69878747381492, -1.0269004767962084),
                (37.69860938434583, -1.0268189996633827),
                (37.69845029749054, -1.0267959980433283),
                (37.69835224681957, -1.0268067637604037),
                (37.69835901939773, -1.0268221923304908),
                (37.69848557608489, -1.0271104795253563),
                (37.69914569626128, -1.028634007026047),
                (37.69927997938723, -1.0289378367848896),
                (37.69930043458497, -1.0289841191423903),
                (37.69930044799598, -1.0289840965112507),
                (37.69930046727437, -1.0289840629836355),
                (37.69930054271151, -1.0289839339023192),
                (37.699300643294336, -1.0289837629114844),
                (37.69930511001084, -1.0289761345409534),
                (37.69930587779319, -1.028974823611219),
                (37.69932023347961, -1.0289503057047906),
                (37.69934003321245, -1.0289164922671907),
                (37.699374883491544, -1.02875326558967),
                (37.69940535506416, -1.0285006651878752),
                (37.699056645240276, -1.0276153693603196),
                (37.699077753388295, -1.0276008661523979),
                (37.699209978756926, -1.0275100155366967),
                (37.69927995256512, -1.0275501262985245),
                (37.69944706174044, -1.027720086159264),
                (37.69948978681802, -1.0277635404624665),
                (37.69950437887414, -1.027626776293026),
                (37.69951601211824, -1.0274394088947418),
                (37.699516717874516, -1.0273206951548572),
                (37.699517259345484, -1.0272296559463234),
                (37.69951746051119, -1.0271958399941528),
                (37.69951754181565, -1.0271821573745998),
                (37.69951754433022, -1.027181784379887),
                (37.69951754684479, -1.0271813200224233),
                (37.699517552712095, -1.0271804005275904),
                (37.6995175619322, -1.027178810480464),
                (37.69951764575123, -1.027164728044106),
                (37.69951786032797, -1.0271286657417515),
                (37.699517869548075, -1.0271270765328153),
                (37.69951790056112, -1.0271219677625278),
                (37.699518370785924, -1.027042907970721),
                (37.69951837497685, -1.0270421485702483),
                (37.69951565253453, -1.0269774603904758),
                (37.69951523260117, -1.026967487601488),
                (37.69951894326995, -1.0265810801658677),
                (37.69951727359475, -1.026524414306099),
                (37.699520655692865, -1.0264572928596907),
                (37.699510521971334, -1.0264519636453366),
                (37.69940300477836, -1.0263954235141233),
                (37.69933416168895, -1.0263355113430626),
                (37.69920153398894, -1.0262200891767492),
                (37.69912072908481, -1.0261735805078498),
                (37.69892181729058, -1.0261510692291598),
                (37.69892141412102, -1.0261501053102378),
                (37.698766634726056, -1.0257799948099253),
                (37.69876174304703, -1.0256550231407595),
                (37.69919746541292, -1.0254608571804078),
                (37.69933739961833, -1.0253985050371885),
                (37.69932363988525, -1.025326760970906),
                (37.69930481915874, -1.0252412865082197),
                (37.69930098695241, -1.0252412831554583),
                (37.69843829879544, -1.0252405530916484),
                (37.69834500820755, -1.0252345348848126),
                (37.69828113810159, -1.0252415991532264),
                (37.69794257289577, -1.0252287455039468),
                (37.69766024439619, -1.0252300581100617),
            ],
            "Agria_p4": [
                (37.699056645240276, -1.0276153693603196),
                (37.69940535506416, -1.0285006651878752),
                (37.69940640196394, -1.028491965610055),
                (37.699428300525454, -1.0283099651446916),
                (37.699450398576275, -1.0281335788784072),
                (37.69948481970191, -1.0278100994227883),
                (37.699489787656205, -1.027763541300657),
                (37.69944706174044, -1.027720086159264),
                (37.69927995256512, -1.0275501262985245),
                (37.699209978756926, -1.0275100155366967),
                (37.699056645240276, -1.0276153693603196),
            ],
            "Agria_p5": [
                (37.6990336637368, -1.0298169191072535),
                (37.69903722436948, -1.0298180070783498),
                (37.69903798544635, -1.0298182392570816),
                (37.699128891382614, -1.0298460655008892),
                (37.699135181163115, -1.0298479908241625),
                (37.69915692214485, -1.0298546737159593),
                (37.69949276071743, -1.029845782192545),
                (37.69939821032945, -1.0296645092764203),
                (37.69936912428554, -1.0297474079801086),
                (37.69919459796368, -1.0297249411255085),
                (37.69919444122206, -1.0297254448779192),
                (37.69910123193867, -1.0297153857553234),
                (37.699080360160366, -1.029765845653614),
                (37.69904875954532, -1.0298079236482336),
                (37.6990336637368, -1.0298169191072535),
            ],
            "Agria_p6": [
                (37.6990336637368, -1.0298169191072535),
                (37.699037034938456, -1.0298179492432147),
                (37.69903722436948, -1.0298180070783498),
                (37.69903724364785, -1.0298180129456824),
                (37.69903798544635, -1.0298182392570816),
                (37.69909204369587, -1.0298347868113091),
                (37.699128891382614, -1.0298460655008892),
                (37.699133243266985, -1.0298473973853826),
                (37.699135181163115, -1.0298479908241625),
                (37.699139638659474, -1.0298493612654125),
                (37.69915692214485, -1.0298546737159593),
                (37.69915934702961, -1.029854609175301),
                (37.69949276071743, -1.029845782192545),
                (37.69939821032945, -1.0296645092764203),
                (37.69937303695815, -1.0297362566954644),
                (37.69936912428554, -1.0297474079801086),
                (37.69919459796368, -1.0297249411255085),
                (37.69919444122206, -1.0297254448779192),
                (37.69910816880217, -1.0297161342593213),
                (37.69910123193867, -1.0297153857553234),
                (37.699084514231814, -1.0297558024566353),
                (37.699080360160366, -1.029765845653614),
                (37.699077209402745, -1.0297700407964017),
                (37.69904875954532, -1.0298079236482336),
                (37.6990336637368, -1.0298169191072535),
            ],
            "Agria_p7": [
                (37.69907215762943, -1.0320032716246408),
                (37.6993069297221, -1.0324680967982467),
                (37.70041065041565, -1.0317084725288135),
                (37.700353863018236, -1.031578518656106),
                (37.70030807686945, -1.031474951016155),
                (37.700300384796435, -1.031457551860514),
                (37.700143975959364, -1.0315586091203155),
                (37.699820272706916, -1.0317677552189086),
                (37.699788114695295, -1.0316785818221317),
                (37.69976440061343, -1.0316128241114513),
                (37.69974737780525, -1.0315656205827368),
                (37.69972955703987, -1.0315162059078338),
                (37.699530797796314, -1.031659590942984),
                (37.69922475186213, -1.0318803719620626),
                (37.699086030518174, -1.0319543607021484),
                (37.69911414174672, -1.0319809514533549),
                (37.69907215762943, -1.0320032716246408),
            ],
            "Agria_p8": [
                (37.699647530892335, -1.0312780424969221),
                (37.699671625512636, -1.031348001217723),
                (37.69972955703987, -1.0315162059078338),
                (37.69974738115802, -1.031565630641021),
                (37.69976440061343, -1.0316128241114513),
                (37.699788114695295, -1.0316785818221317),
                (37.69979284627992, -1.031674257598028),
                (37.69979476741224, -1.0316743405788744),
                (37.69979487386243, -1.0316743456080166),
                (37.69979534324902, -1.0316743657245853),
                (37.69980042771179, -1.031684477653174),
                (37.69980167326267, -1.0316869553438994),
                (37.69980934354274, -1.0317022112467713),
                (37.6998142192961, -1.0316987788572178),
                (37.69981614126661, -1.031697425179775),
                (37.699830299140075, -1.0316874582581197),
                (37.699860977745715, -1.031699612856633),
                (37.69988453089502, -1.0316989431425296),
                (37.69995443848623, -1.0316651632325446),
                (37.70000427728546, -1.031631897133255),
                (37.700056784044605, -1.0315968498794348),
                (37.70007782346103, -1.0315627346933025),
                (37.700265164037205, -1.0314190671879988),
                (37.70027926826651, -1.031409753216639),
                (37.700090583232964, -1.0309826491241247),
                (37.699797532602275, -1.0311780329750797),
                (37.699738851732846, -1.031217156348655),
                (37.699647530892335, -1.0312780424969221),
            ],
            "Agria_p9": [
                (37.699788114695295, -1.0316785818221317),
                (37.699820272706916, -1.0317677552189086),
                (37.700144415171124, -1.0315583249737814),
                (37.700300384796435, -1.031457551860514),
                (37.70027926826651, -1.031409753216639),
                (37.700265164037205, -1.0314190671879988),
                (37.70007782346103, -1.0315627346933025),
                (37.700056784044605, -1.0315968498794348),
                (37.70000426890354, -1.0316319030005874),
                (37.69995443848623, -1.0316651632325446),
                (37.69988453089502, -1.0316989431425296),
                (37.699860977745715, -1.031699612856633),
                (37.699830299140075, -1.0316874582581197),
                (37.699827787083564, -1.0316892268397944),
                (37.699816135399274, -1.0316974302089172),
                (37.69980934354274, -1.0317022112467713),
                (37.69980167326267, -1.0316869553438994),
                (37.69979534324902, -1.0316743657245853),
                (37.69979476741224, -1.0316743405788744),
                (37.69979284627992, -1.031674257598028),
                (37.699788114695295, -1.0316785818221317),
            ],
            "Agria_p10": [
                (37.69851753293082, -1.0300311873871795),
                (37.69852187810967, -1.0300337514115123),
                (37.69852575138739, -1.0300322560798976),
                (37.69854088323807, -1.029920666119943),
                (37.69856561488304, -1.0297974412395023),
                (37.69856733820244, -1.029788853141001),
                (37.69857791281211, -1.0297724246098057),
                (37.69860452703267, -1.0297310775171862),
                (37.69860204598915, -1.0297250056661669),
                (37.69863627684555, -1.029675984102546),
                (37.698704674855904, -1.0296377626218058),
                (37.69879444755881, -1.029637260545776),
                (37.6988860651187, -1.0293784214930783),
                (37.69894594879126, -1.0291624776706088),
                (37.698950682052256, -1.0291620669573287),
                (37.698954283756265, -1.0291659519696803),
                (37.69883359188711, -1.0296503371536931),
                (37.69886238456442, -1.0296599553881558),
                (37.69902300111714, -1.0290153107205218),
                (37.698995536971566, -1.0290003875792257),
                (37.69896684068617, -1.0291155557738574),
                (37.69896241587921, -1.0291162632065274),
                (37.69895882171892, -1.0291129364289604),
                (37.69898028190687, -1.0289822826672963),
                (37.69884407261948, -1.0289280483977823),
                (37.69879076287394, -1.0289174025419296),
                (37.69875698296396, -1.0289270417311513),
                (37.698717418702245, -1.0290584733334764),
                (37.698547174694966, -1.0297107690027814),
                (37.6985351039155, -1.0298722933156665),
                (37.69852901362428, -1.0299036785157727),
                (37.69852253022178, -1.029937087107425),
                (37.69852183871474, -1.0299501125857302),
                (37.69851753293082, -1.0300311873871795),
            ],
            "Monalisa_p1": [
                (37.69925437518609, -1.0293451478500752),
                (37.699266267431, -1.0293708828089165),
                (37.699285484621555, -1.0294124687857906),
                (37.6992858626454, -1.0294111628851987),
                (37.69928622055271, -1.0294099273925976),
                (37.699341024791664, -1.0295345109796232),
                (37.69939821032945, -1.0296645092764203),
                (37.69949276071743, -1.029845782192545),
                (37.69958605968719, -1.0298433120455333),
                (37.69958705461917, -1.0298432860616318),
                (37.69932965306296, -1.029260747109249),
                (37.699325924792205, -1.0292523090468233),
                (37.69930990194514, -1.0292160472551612),
                (37.69930882570873, -1.029213610635764),
                (37.699290466825104, -1.0292579609644685),
                (37.69925437518609, -1.0293451478500752),
            ],
            "Monalisa_p2": [
                (37.69925437518609, -1.0293451478500752),
                (37.699285484621555, -1.0294124687857906),
                (37.69928622055271, -1.0294099273925976),
                (37.69939821032945, -1.0296645092764203),
                (37.69949276071743, -1.029845782192545),
                (37.69958705461917, -1.0298432860616318),
                (37.69932965306296, -1.029260747109249),
                (37.69930990194514, -1.0292160472551612),
                (37.69930882570873, -1.029213610635764),
                (37.69925437518609, -1.0293451478500752),
            ],
            "Monalisa_p3": [
                (37.69883816002462, -1.0297571846325506),
                (37.6990336637368, -1.0298169191072535),
                (37.69904875954532, -1.0298079236482336),
                (37.69906982746021, -1.029779871093027),
                (37.69907309221166, -1.0297755225614023),
                (37.6990775438407, -1.0297695957173163),
                (37.699080360160366, -1.029765845653614),
                (37.69910123193867, -1.0297153857553234),
                (37.69885521216946, -1.0296887438745046),
                (37.69883816002462, -1.0297571846325506),
            ],
            "Monalisa_p4": [
                (37.69883816002462, -1.0297571846325506),
                (37.6990336637368, -1.0298169191072535),
                (37.69904875954532, -1.0298079236482336),
                (37.699080360160366, -1.029765845653614),
                (37.69910123193867, -1.0297153857553234),
                (37.69885521216946, -1.0296887438745046),
                (37.69883816002462, -1.0297571846325506),
            ],
            "Monalisa_p5": [
                (37.69860204598915, -1.0297250056661669),
                (37.69860452703267, -1.0297310775171862),
                (37.6986058111403, -1.0297290834623027),
                (37.69868090712984, -1.0297090616090037),
                (37.69880920054746, -1.0297483224457993),
                (37.69883816002462, -1.0297571846325506),
                (37.69885521216946, -1.0296887438745046),
                (37.69886238456442, -1.0296599553881558),
                (37.69883359188711, -1.0296503371536931),
                (37.698954283756265, -1.0291659519696803),
                (37.698950682052256, -1.0291620669573287),
                (37.69894594879126, -1.0291624776706088),
                (37.6988860651187, -1.0293784214930783),
                (37.69879444755881, -1.029637260545776),
                (37.698704674855904, -1.0296377626218058),
                (37.69863627684555, -1.029675984102546),
                (37.69860204598915, -1.0297250056661669),
            ],
            "Monalisa_p6": [
                (37.69653787061425, -1.0304915559026033),
                (37.69655001934545, -1.030598412601555),
                (37.696577382908174, -1.030715073613231),
                (37.69661519451384, -1.0308257885024423),
                (37.69670777347805, -1.0310053716267868),
                (37.69679108289502, -1.0311803237493526),
                (37.69685830157151, -1.0313900666394868),
                (37.696953737088506, -1.0319347763842208),
                (37.69699518644036, -1.0321287571045015),
                (37.697632869937024, -1.0313676442089763),
                (37.69747509987876, -1.0311593094786586),
                (37.69746946388675, -1.0311518671863893),
                (37.697465909959604, -1.0311471741585239),
                (37.69746302742291, -1.0311433679360669),
                (37.69746206266579, -1.0311420947248993),
                (37.69745934357624, -1.0311385039173666),
                (37.69741898638645, -1.0310852126120158),
                (37.69736418633842, -1.0310128491230517),
                (37.697292268766745, -1.0309178821544573),
                (37.696584614814654, -1.0299832370308482),
                (37.696546386628384, -1.030359428602274),
                (37.69653787061425, -1.0304915559026033),
            ],
            "Monalisa_p7": [
                (37.69653787061425, -1.0304915559026033),
                (37.69655001934545, -1.030598412601555),
                (37.69656354773798, -1.0306560901570971),
                (37.69656810414078, -1.0306755143806643),
                (37.696577382908174, -1.030715073613231),
                (37.69661519451384, -1.0308257885024423),
                (37.69663851045526, -1.0308710164164612),
                (37.69665662291091, -1.0309061508420796),
                (37.69670777347805, -1.0310053716267868),
                (37.69679108289502, -1.0311803237493526),
                (37.69685830157151, -1.0313900666394868),
                (37.696953737088506, -1.0319347763842208),
                (37.69699518644036, -1.0321287571045015),
                (37.697632869937024, -1.0313676442089763),
                (37.69747509987876, -1.0311593094786586),
                (37.69746946388675, -1.0311518671863893),
                (37.697465909959604, -1.0311471741585239),
                (37.697462841344674, -1.031143122346289),
                (37.69746206266579, -1.0311420947248993),
                (37.69745934357624, -1.0311385039173666),
                (37.69741898638645, -1.0310852126120158),
                (37.69736418633842, -1.0310128491230517),
                (37.697292268766745, -1.0309178821544573),
                (37.696584614814654, -1.0299832370308482),
                (37.696546386628384, -1.030359428602274),
                (37.69653787061425, -1.0304915559026033),
            ],
            "Monalisa_p8": [
                (37.698506066486615, -1.029946594700759),
                (37.69664353959746, -1.0295311607327258),
                (37.696617335251986, -1.0297248036622884),
                (37.696590641403404, -1.0299231941020903),
                (37.696584614814654, -1.0299832370308482),
                (37.697292268766745, -1.0309178821544573),
                (37.69736418633842, -1.0310128491230517),
                (37.69741898638645, -1.0310852126120158),
                (37.69745934357624, -1.0311385039173666),
                (37.69746206266579, -1.0311420947248993),
                (37.69746302742291, -1.0311433679360669),
                (37.697465909959604, -1.0311471741585239),
                (37.69746946388675, -1.0311518671863893),
                (37.69747509987876, -1.0311593094786586),
                (37.697632869937024, -1.0313676442089763),
                (37.69788435386921, -1.0316997704364224),
                (37.698274527294146, -1.032215140165546),
                (37.6983307790879, -1.032098401202166),
                (37.698474727386966, -1.0301501819208372),
                (37.69850141117729, -1.0299869963146446),
                (37.698506066486615, -1.029946594700759),
            ],
            "Monalisa_p9": [
                (37.696584614814654, -1.0299832370308482),
                (37.697292268766745, -1.0309178821544573),
                (37.69736418633842, -1.0310128491230517),
                (37.69741898638645, -1.0310852126120158),
                (37.69745934357624, -1.0311385039173666),
                (37.697462841344674, -1.031143122346289),
                (37.697462890797894, -1.0311431868869476),
                (37.69746302742291, -1.0311433679360669),
                (37.697465909959604, -1.0311471741585239),
                (37.69746946388675, -1.0311518671863893),
                (37.69747509987876, -1.0311593094786586),
                (37.697632869937024, -1.0313676442089763),
                (37.69788435386921, -1.0316997704364224),
                (37.698274527294146, -1.032215140165546),
                (37.6983307790879, -1.032098401202166),
                (37.698474727386966, -1.0301501819208372),
                (37.69850141117729, -1.0299869963146446),
                (37.698506066486615, -1.029946594700759),
                (37.69664353959746, -1.0295311607327258),
                (37.696617335251986, -1.0297248036622884),
                (37.696590641403404, -1.0299231941020903),
                (37.696584614814654, -1.0299832370308482),
            ],
            "Monalisa_p10": [
                (37.698274527294146, -1.032215140165546),
                (37.69788435386921, -1.0316997704364224),
                (37.69772047005044, -1.0319183512057872),
                (37.698039514640854, -1.0322971176980207),
                (37.69808680701772, -1.0322958671179931),
                (37.69817460326773, -1.0322646244102491),
                (37.698274527294146, -1.032215140165546),
            ],
            "Spunta_p1": [
                (37.69772047005044, -1.0319183512057872),
                (37.698039514640854, -1.0322971176980207),
                (37.69808680701772, -1.0322958671179931),
                (37.69817460326773, -1.0322646244102491),
                (37.698274527294146, -1.032215140165546),
                (37.69788435386921, -1.0316997704364224),
                (37.69772047005044, -1.0319183512057872),
            ],
            "Spunta_p2": [
                (37.69582386234099, -1.029074626100041),
                (37.69612898207478, -1.0294341251103056),
                (37.69632306756888, -1.0296747519627065),
                (37.69655319776331, -1.0299152254262698),
                (37.69657980192555, -1.029716836662849),
                (37.69660073992095, -1.0295622643008686),
                (37.69583084111396, -1.0290446138557563),
                (37.69582386234099, -1.029074626100041),
            ],
            "Spunta_p3": [
                (37.69582386234099, -1.029074626100041),
                (37.69597027072878, -1.0292471273539738),
                (37.69612898207478, -1.0294341251103056),
                (37.69632306756888, -1.0296747519627065),
                (37.69652433132525, -1.0298850614695287),
                (37.69655319776331, -1.0299152254262698),
                (37.69656405903409, -1.0298342344438571),
                (37.69657980192555, -1.029716836662849),
                (37.69660073992095, -1.0295622643008686),
                (37.696326683522116, -1.0293779990451335),
                (37.69597661666806, -1.0291426276463347),
                (37.69583084111396, -1.0290446138557563),
                (37.69582386234099, -1.029074626100041),
            ],
            "Spunta_p4": [
                (37.69583084111396, -1.0290446138557563),
                (37.69632597860402, -1.029377525467576),
                (37.69660073992095, -1.0295622643008686),
                (37.69665190641372, -1.0291839143892474),
                (37.69604666088428, -1.0288120679966846),
                (37.69590470496371, -1.0287248693764128),
                (37.69587505146488, -1.0288532340401848),
                (37.695874904781576, -1.0288538693884832),
                (37.69583084111396, -1.0290446138557563),
            ],
            "Spunta_p5": [
                (37.69583084111396, -1.0290446138557563),
                (37.69660073992095, -1.0295622643008686),
                (37.69665190641372, -1.0291839143892474),
                (37.69604666088428, -1.0288120679966846),
                (37.69590470496371, -1.0287248693764128),
                (37.69583084111396, -1.0290446138557563),
            ],
            "Spunta_p6": [
                (37.69590470496371, -1.0287248693764128),
                (37.69604666088428, -1.0288120679966846),
                (37.69665190641372, -1.0291839143892474),
                (37.69667436740097, -1.0290180725577815),
                (37.69680750555888, -1.0282442241978182),
                (37.69683444918823, -1.0280879033707324),
                (37.69689750457316, -1.027806321698804),
                (37.69690521424816, -1.0277810552883775),
                (37.69699327704271, -1.0274924554485054),
                (37.69698344255512, -1.0274699181859146),
                (37.69698109478391, -1.0274645378419478),
                (37.69688737085164, -1.0274538651640035),
                (37.69680492225615, -1.0274491319030006),
                (37.69671571281722, -1.02742278255062),
                (37.69660829955984, -1.0273910570452247),
                (37.6964586406698, -1.0273127365373216),
                (37.69645628786944, -1.027311505235672),
                (37.69645059236589, -1.027309532135548),
                (37.69631515253725, -1.027262621135272),
                (37.69620472095639, -1.027217460276482),
                (37.6961746726699, -1.0272151946479198),
                (37.69615728943988, -1.0272921648311415),
                (37.69605335299616, -1.0277523682230634),
                (37.69599040238502, -1.028164371477924),
                (37.69590470496371, -1.0287248693764128),
            ],
            "Spunta_p7": [
                (37.695957106949066, -1.0287017839373218),
                (37.696083927666194, -1.0287916421356287),
                (37.69615894821861, -1.028750653788486),
                (37.69652197601033, -1.028994913357938),
                (37.69658341704064, -1.029025592801755),
                (37.6966121678084, -1.0290248384304248),
                (37.69663932601449, -1.0289232472433596),
                (37.69671635990018, -1.0283569507439108),
                (37.69682030053484, -1.0278625734925313),
                (37.696887107659876, -1.0276431302252784),
                (37.69690789561915, -1.0275417896571333),
                (37.69689792115379, -1.0275179012316704),
                (37.69670555143537, -1.0275149650508142),
                (37.69653179038134, -1.027475232312842),
                (37.69636414811697, -1.0274191540245208),
                (37.696274208614184, -1.0274054898451561),
                (37.69622249059216, -1.027378582257991),
                (37.69617756275029, -1.0273757324107424),
                (37.69617253276991, -1.0274564518194764),
                (37.696192817814946, -1.0275244315728207),
                (37.69620053587187, -1.0275720047434869),
                (37.69620715087025, -1.0276127793520853),
                (37.69602860710195, -1.0286250886805408),
                (37.695980996212725, -1.0286545929814632),
                (37.69596833953817, -1.0286670820179333),
                (37.695957106949066, -1.0287017839373218),
            ],
            "Spunta_p8": [
                (37.695957106949066, -1.0287017839373218),
                (37.696083927666194, -1.0287916421356287),
                (37.69615894821861, -1.028750653788486),
                (37.69631182156873, -1.0288535131575771),
                (37.696396625479125, -1.0289105729668184),
                (37.69652197601033, -1.028994913357938),
                (37.69658341704064, -1.029025592801755),
                (37.6966121678084, -1.0290248384304248),
                (37.69663932601449, -1.0289232472433596),
                (37.69671635990018, -1.0283569507439108),
                (37.69678861442438, -1.0280132843114902),
                (37.69682030053484, -1.0278625734925313),
                (37.69683384066201, -1.027818098273462),
                (37.696887107659876, -1.0276431302252784),
                (37.69690592503359, -1.0275513953187403),
                (37.69690789561915, -1.0275417896571333),
                (37.696905254481294, -1.0275354629962419),
                (37.69690503319906, -1.0275349349363108),
                (37.69689792115379, -1.0275179012316704),
                (37.69677525199356, -1.0275160287143903),
                (37.69670555143537, -1.0275149650508142),
                (37.69664297130437, -1.027500655464867),
                (37.69653179038134, -1.027475232312842),
                (37.696438482191496, -1.0274440197799517),
                (37.69636414811697, -1.0274191540245208),
                (37.696302367619595, -1.0274097679687897),
                (37.696274208614184, -1.0274054898451561),
                (37.69622249059216, -1.027378582257991),
                (37.696199995239084, -1.027377155657986),
                (37.69617756275029, -1.0273757324107424),
                (37.6961767949679, -1.0273880496181873),
                (37.69617660553689, -1.0273910956019814),
                (37.69617253276991, -1.0274564518194764),
                (37.696192817814946, -1.0275244315728207),
                (37.69619556875577, -1.0275413906785185),
                (37.69620157355156, -1.0275784009741784),
                (37.69620715087025, -1.0276127793520853),
                (37.69612384983516, -1.0280850795073855),
                (37.69612157414835, -1.0280979851244678),
                (37.69612157163377, -1.028097999373704),
                (37.69607568574031, -1.0283581610908008),
                (37.69607567400564, -1.0283582298224108),
                (37.69602860710195, -1.0286250886805408),
                (37.695980996212725, -1.0286545929814632),
                (37.695972583296026, -1.028662894418859),
                (37.695971863290495, -1.0286636043661002),
                (37.69597177444231, -1.0286636923760886),
                (37.69596833953817, -1.0286670820179333),
                (37.695957106949066, -1.0287017839373218),
            ],
            "Spunta_p9": [
                (37.696649164693, -1.0294895915196591),
                (37.69671558289771, -1.0295004796125278),
                (37.69847908513867, -1.0298708843176594),
                (37.69851156836816, -1.0298777071872478),
                (37.69874839989461, -1.0282026499556094),
                (37.69869767764274, -1.0280949215386759),
                (37.698640225560396, -1.0279728977850318),
                (37.69853205038797, -1.027743145614454),
                (37.69798009616392, -1.0276111239261105),
                (37.69797815072407, -1.02758183001097),
                (37.697912505330876, -1.0275734514600605),
                (37.69778658734481, -1.02755833553498),
                (37.69772494263425, -1.0282661596397258),
                (37.69776347759817, -1.028292011107028),
                (37.69763716063349, -1.0290323838201096),
                (37.69719064656664, -1.0289357664546828),
                (37.69674413752894, -1.0288391507656365),
                (37.69671173895668, -1.029027176981549),
                (37.696649164693, -1.0294895915196591),
            ],
            "Spunta_p10": [
                (37.69517688834232, -1.030815653104523),
                (37.695246766596824, -1.0309256303862113),
                (37.69537775312007, -1.0310573486496417),
                (37.69542046059567, -1.0310945525672763),
                (37.69558596379824, -1.03061977220668),
                (37.69557461218609, -1.0306115428536557),
                (37.69562061458801, -1.030474688997846),
                (37.69586896285007, -1.029735851011327),
                (37.69600340607039, -1.0293358808173765),
                (37.696007406753, -1.0293400667400698),
                (37.696015075356655, -1.0293480890600732),
                (37.695796920388005, -1.0290909909287682),
                (37.69519695294332, -1.0307597759818898),
                (37.69517688834232, -1.030815653104523),
            ],
        }




        # definición del mapa de parcelas con zoom automático
        def show_static_map(global_preds, ranking_df, parcel_coords):
            min_pred = np.min(global_preds)
            max_pred = np.max(global_preds)

            def rendimiento_color(value):
                ratio = (value - min_pred) / (max_pred - min_pred + 1e-8)
                r = int(255 * (1 - ratio))
                g = int(180 * ratio)
                b = 0
                return f"rgb({r},{g},{b})"

            # recopilar todos los puntos de todas las parcelas
            all_coords = []
            for coords in parcel_coords.values():
                all_coords.extend(coords)

            # calcular centroides aproximados
            mean_lat = np.mean([c[0] for c in all_coords])
            mean_lon = np.mean([c[1] for c in all_coords])

            # calcular bounding box para ajustar mejor el zoom
            min_lat = min(c[0] for c in all_coords)
            max_lat = max(c[0] for c in all_coords)
            min_lon = min(c[1] for c in all_coords)
            max_lon = max(c[1] for c in all_coords)

            # inicializar mapa centrado en el promedio
            m = folium.Map(location=[mean_lat, mean_lon], zoom_start=14, tiles="cartodbpositron")

            # ajustar la vista para que incluya todas las parcelas
            m.fit_bounds([[min_lat, min_lon], [max_lat, max_lon]])

            # añadir polígonos
            for parcela in ranking_df["Parcela"].tolist():
                coords = parcel_coords.get(parcela)
                if coords:
                    rendimiento = ranking_df.loc[
                        ranking_df["Parcela"] == parcela, "Predicción rendimiento (ton/ha)"
                    ].values[0]
                    color = rendimiento_color(rendimiento)
                    folium.Polygon(
                        locations=coords,
                        color="black",
                        fill=True,
                        fill_opacity=0.7,
                        fill_color=color,
                        weight=1,
                        popup=f"""
                            <b>{parcela}</b><br>
                            Rendimiento: {rendimiento:.2f} ton/ha
                        """,
                    ).add_to(m)

            return m._repr_html_()


        # sólo se renderiza una vez
        if "static_map" not in st.session_state:
            st.session_state["static_map"] = show_static_map(global_preds, ranking_df, parcel_coords)

        # mostrar
        st.markdown("#### Mapa de parcelas")
        components.html(
            st.session_state["static_map"],
            height=600,
            scrolling=False,
        )
            
            
    else:
        parcela_sel = st.selectbox("Selecciona parcela", parcelas)
        datos_p = df[df["parcela"] == parcela_sel].sort_values("fecha")
        st.subheader(f"Detalle parcela: {parcela_sel}")

        mes_cosecha = datos_p["fecha"].max().month
        variedad = datos_p["variedad"].iloc[-1]
        variedad_code = {"Agria":0,"Monalisa":1,"Spunta":2}[variedad]
        tam_parcela_ha = datos_p["tam_parcela_ha"].iloc[-1]
        temp_media = datos_p["temp_media"].mean()
        temp_std = datos_p["temp_media"].std()
        lluvia_total = datos_p["lluvia"].sum()
        fertilizante_total = datos_p["fertilizante"].sum()
        fertilizante_medio = datos_p["fertilizante"].mean()
        riego_total = datos_p["riego"].sum()
        riego_medio = datos_p["riego"].mean()

        X_input = np.array([[variedad_code, tam_parcela_ha, temp_media, temp_std,
                             lluvia_total, fertilizante_total, fertilizante_medio,
                             riego_total, riego_medio, mes_cosecha]])
        pred_stack = stack_model.predict(X_input)[0]

        week_series = datos_p[["temp_media", "lluvia", "fertilizante", "riego"]].values
        ciclo_weeks = 16
        if len(week_series) < ciclo_weeks:
            pad = np.tile(week_series[-1], (ciclo_weeks - len(week_series), 1))
            week_series = np.vstack([week_series, pad])
        else:
            week_series = week_series[-ciclo_weeks:]

        week_series_norm = (week_series - week_series.min(axis=0)) / (
            week_series.max(axis=0) - week_series.min(axis=0) + 1e-8
        )
        week_series_norm = week_series_norm.reshape((1, ciclo_weeks, 4))
        pred_lstm = lstm_model.predict(week_series_norm)[0].flatten()
        pred_lstm_py = [round(float(v),2) for v in pred_lstm]

        col1, col2, col3 = st.columns(3)
        col1.metric("Actual (XGBoost)", f"{pred_stack:.2f} ton/ha")
        col2.metric("Última semana (LSTM)", f"{pred_lstm_py[-1]:.2f} ton/ha")
        col3.metric("Mejor semana", f"{np.argmax(pred_lstm_py)+1}")

        if uploaded_forecast is not None:
            df_forecast_p = df_forecast[df_forecast["parcela"]==parcela_sel]
            st.markdown("#### Recomendaciones próximas semanas")

            reco_data = []
            for _, row in df_forecast_p.iterrows():
                reco_data.append({
                    "Fecha": row['fecha'].strftime("%d/%m/%Y"),
                    "Temperatura alta": "Sí" if row["temp_media"]>28 else "No",
                    "Lluvia baja": "Sí" if row["lluvia"]<2 else "No",
                    "Riego sugerido": f"{row['riego_sugerido_mm']:.1f} mm/día",
                    "Fertilizante sugerido": f"{row['fertilizante_sugerido_kg']:.2f} kg/día"
                })
            st.dataframe(pd.DataFrame(reco_data), use_container_width=True)

            future_opt = [round(pred_lstm_py[-1],2)]
            seq_opt = week_series.tolist()
            fert_acum_opt = datos_p["fertilizante"].sum()
            riego_acum_opt = datos_p["riego"].sum()

            for i in range(4):
                row = df_forecast_p.iloc[min(i,len(df_forecast_p)-1)]
                fert_acum_opt += row["fertilizante_sugerido_kg"]*7
                riego_acum_opt += row["riego_sugerido_mm"]*7
                semana_o = [
                    row["temp_media"],
                    row["lluvia"],
                    fert_acum_opt/(len(seq_opt)+1),
                    riego_acum_opt/(len(seq_opt)+1)
                ]
                seq_opt.append(semana_o)
                seq_o_np = np.array(seq_opt[-ciclo_weeks:])
                seq_o_norm = (seq_o_np - seq_o_np.min(axis=0)) / (
                    seq_o_np.max(axis=0) - seq_o_np.min(axis=0) + 1e-8
                )
                pred_next = lstm_model.predict(seq_o_norm.reshape(1, ciclo_weeks,4))[0][-1]
                future_opt.append(round(float(pred_next),2))

            st.markdown("#### Proyección rendimiento")
            # valores históricos
            historico_labels = [round(v, 2) if v is not None else None for v in pred_lstm_py + [None]*4]
            # escenario futuro
            escenario_labels = [None]*(len(pred_lstm_py)-1) + [round(v, 2) for v in future_opt]

            line_opt = {
                "xAxis": {"type": "category", "data": list(range(1, len(pred_lstm_py) + 5))},
                "yAxis": {
                    "type": "value",
                    "name": "Toneladas por hectárea",
                    "nameLocation": "middle",
                    "nameGap": 35
                },
                "series": [
                    {
                        "data": historico_labels,
                        "type": "line",
                        "smooth": True,
                        "name": "Histórico",
                        "label": {
                            "show": True,
                            "position": "top"
                        },
                        "symbolSize": 6
                    },
                    {
                        "data": escenario_labels,
                        "type": "line",
                        "smooth": True,
                        "name": "Escenario",
                        "label": {
                            "show": True,
                            "position": "top"
                        },
                        "symbolSize": 6,
                        "lineStyle": {"type":"dashed"}
                    }
                ],
                "tooltip": {"trigger": "axis"}
            }

            st_echarts(options=line_opt, height="500px")

        st.markdown("#### Últimos registros")
        st.dataframe(datos_p.tail(5), use_container_width=True)

    # FOOTER
    st.markdown("""
        <div class="footer">
        AMUTIO Predictive IA — Monitorización en vivo | 2025
        </div>
    """, unsafe_allow_html=True)

else:
    st.info("Por favor sube el archivo CSV de seguimiento semanal para comenzar.")
